<!DOCTYPE html>
<html>
<body>
<!-- 1. The <iframe> (and video player) will replace this <div> tag. -->
<div id="player"></div>
<br>
<input id="power" type="button" value="gief control plz" onclick="changeControl()">
<!-- connection script -->
<script>
    var control = false;
    function changeControl(){
        if(control){
            conn.send(JSON.stringify({"command": "changeControl"}));
        } else{
            conn.send(JSON.stringify({"command": "changeControl"}));
        }
    }
    <!-- should be custom username but fuck doing that now -->
    var name = "user"+parseInt(99999*Math.random());
    var conn = new WebSocket("ws://localhost:8000/test");
    conn.onmessage = function(ev){
        try{
            var data = JSON.parse(ev.data)
            console.log("this is the command : " + data.command)
            //used to check for control but this is now moved serverside. messages no longer arrive without being controlling
            if(true){
                if(data.command === "changeControl"){
                    var button = document.getElementById("power")
                    if(data.control === true){
                        button.value = "give up control"
                        control = true;
                    } else if(data.control === false){
                        button.value = "take control"
                        control = false;
                    }
                } else if(data.command === "pause"){
                    player.pauseVideo();
                } else if(data.command === "play"){
                    var timeDifference = player.getCurrentTime() - data.time;
                    if(timeDifference > 5 || timeDifference < -5){
                        player.seekTo(data.time);
                    }
                    player.playVideo();
                } else if(data.command === "join"){
                    try{
                        conn.send(JSON.stringify({"command": "update", "time": player.getCurrentTime()}));
                    }catch(err){
                        console.log(err)
                    }

                } else if(data.command === "update"){
                    player.seekTo(data.time);
                    player.playVideo();
                }
            }
        } catch(err){
            console.log(err);
        }

    }

</script>
<!-- youtube script -->
<script>
    var videoId = 'cAiBZyTIKV4';
    // 2. This code loads the IFrame Player API code asynchronously.
    var tag = document.createElement('script');

    tag.src = "https://www.youtube.com/iframe_api";
    var firstScriptTag = document.getElementsByTagName('script')[0];
    firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

    // 3. This function creates an <iframe> (and YouTube player)
    //    after the API code downloads.
    var player;
    function onYouTubeIframeAPIReady() {
        player = new YT.Player('player', {
            height: '390',
            width: '640',
            videoId: videoId,
            events: {
                'onReady': onPlayerReady,
                'onStateChange': onPlayerStateChange
            }
        });
    }

    // 4. The API will call this function when the video player is ready.
    function onPlayerReady(event) {
        conn.send(JSON.stringify({"command" : "join"}))
    }

    // 5. The API calls this function when the player's state changes.
    //    The function indicates that when playing a video (state=1),
    //    the player should play for six seconds and then stop.
    function onPlayerStateChange(event) {
        if(event.data == YT.PlayerState.PAUSED){
            if(control){
                conn.send(JSON.stringify({"command": "pause", "time": event.target.getCurrentTime()}));
            }
        } else if (event.data == YT.PlayerState.PLAYING) {
            if(control){
                conn.send(JSON.stringify({"command": "play", "time": event.target.getCurrentTime()}));
            }
        }
    }
    function stopVideo() {
        player.stopVideo();
    }
</script>
</body>
</html>